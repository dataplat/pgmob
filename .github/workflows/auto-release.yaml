name: Auto Release from Changelog

on:
  push:
    branches:
      - main
    # paths:
    #   - 'CHANGELOG.md'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Parse Changelog
        id: changelog
        run: |
          RESULT=$(python3 .github/scripts/parse_changelog.py)
          echo "version=$(echo "$RESULT" | jq -r '.version')" >> $GITHUB_OUTPUT
          echo "tag=$(echo "$RESULT" | jq -r '.tag')" >> $GITHUB_OUTPUT
          echo "body=$(echo "$RESULT" | jq -r '.body')" >> $GITHUB_OUTPUT

      - name: Check if release exists
        id: check_release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.changelog.outputs.tag }}"

          if gh release view "$TAG" &>/dev/null; then
            echo "Release $TAG already exists"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $TAG does not exist"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        if: steps.check_release.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.changelog.outputs.tag }}"
          VERSION="${{ steps.changelog.outputs.version }}"
          BODY="${{ steps.changelog.outputs.body }}"

          gh release create "$TAG" \
            --title "Release $VERSION" \
            --notes "$BODY" \
            --verify-tag

      - name: Skip Release
        if: steps.check_release.outputs.exists == 'true'
        run: |
          echo "Release ${{ steps.changelog.outputs.tag }} already exists. Skipping creation."
