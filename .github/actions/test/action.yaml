name: UV Test
description: Run tests
branding:
  icon: play-circle
  color: yellow

inputs:
  PYTHON_VERSION:
    description: Python version
    required: false
    default: 3.9
  UV_EXTRAS:
    description: PyPI extras to install
    required: false
    default: psycopg2-binary
  POSTGRES_VERSION:
    description: Postgres major version to use
    required: false
    default: 12
  CONTAINER_NETWORK:
    description: Docker container network to use
    required: false
    default: pgmob-network

runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Prepare network
      run: |
        docker network create ${{ inputs.CONTAINER_NETWORK}} || docker network inspect ${{ inputs.CONTAINER_NETWORK}}
      shell: bash

    - name: Prepare container
      run: >
        docker build . -t pgmobtest
        --build-arg PYTHON_VERSION=${{ inputs.PYTHON_VERSION }}
        --build-arg UV_EXTRAS=${{ inputs.UV_EXTRAS }}
      shell: bash

    - name: Run ty type checks
      run: docker run --rm -i pgmobtest uv run ty check src/pgmob
      shell: bash

    - name: Run pytest tests
      run: >
        docker run --rm -i --network ${{ inputs.CONTAINER_NETWORK}}
        -e PGMOB_IMAGE=postgres:${{ inputs.POSTGRES_VERSION }}
        -e PGMOB_CONTAINER_NETWORK=${{ inputs.CONTAINER_NETWORK}}
        -v /var/run/docker.sock:/var/run/docker.sock
        pgmobtest uv run pytest -vv
      shell: bash
